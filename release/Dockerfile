FROM lyrasis/archivesspace:base
MAINTAINER Mark Cooper <mark.c.cooper@outlook.com>

ARG ARCHIVESSPACE_DB_TYPE
ARG ARCHIVESSPACE_DB_HOST_TYPE
ARG ARCHIVESSPACE_DB_NAME
ARG ARCHIVESSPACE_DB_USER
ARG ARCHIVESSPACE_DB_PASS
ARG ARCHIVESSPACE_URL
ARG ARCHIVESSPACE_VERSION
ARG MYSQL_CONNECTOR_VERSION

ENV ARCHIVESSPACE_VERSION=${ARCHIVESSPACE_VERSION:-1.5.2}

ENV ARCHIVESSPACE_URL=${ARCHIVESSPACE_URL:-https://github.com/archivesspace/archivesspace/releases/download/v$ARCHIVESSPACE_VERSION/archivesspace-v$ARCHIVESSPACE_VERSION.zip} \
  ARCHIVESSPACE_DB_TYPE=${ARCHIVESSPACE_DB_TYPE:-demo} \
  ARCHIVESSPACE_DB_HOST_TYPE=${ARCHIVESSPACE_DB_HOST_TYPE:-internal} \
  ARCHIVESSPACE_DB_NAME=${ARCHIVESSPACE_DB_NAME:-archivesspace} \
  ARCHIVESSPACE_DB_USER=${ARCHIVESSPACE_DB_USER:-archivesspace} \
  ARCHIVESSPACE_DB_PASS=${ARCHIVESSPACE_DB_PASS:-archivesspace} \
  MYSQL_CONNECTOR_VERSION=${MYSQL_CONNECTOR_VERSION:-5.1.39}

RUN wget $ARCHIVESSPACE_URL
RUN unzip archivesspace-v$ARCHIVESSPACE_VERSION.zip
RUN wget http://central.maven.org/maven2/mysql/mysql-connector-java/${MYSQL_CONNECTOR_VERSION}/mysql-connector-java-${MYSQL_CONNECTOR_VERSION}.jar

# FINALIZE SETUP
RUN rm -rf /archivesspace/plugins/*
RUN cp /mysql-connector-java-${MYSQL_CONNECTOR_VERSION}.jar /archivesspace/lib/
ADD setup.sh /setup.sh
RUN chmod u+x /*.sh

EXPOSE 8080 8081 8089 8090

CMD ["/setup.sh"]
